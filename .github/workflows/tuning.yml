name: Tuning Automation

on:
  schedule:
    # Run nightly at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:
    # Manual trigger

jobs:
  tuning:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          
      - name: Install dependencies
        run: |
          cd backend
          pip install -r requirements.txt
          pip install supabase
          
      - name: Generate question effectiveness report
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          SUPABASE_DB_URL: ${{ secrets.SUPABASE_DB_URL }}
        run: |
          cd backend
          python scripts/question_effectiveness_report.py
          
      - name: Copy effectiveness report to data_cache
        run: |
          mkdir -p backend/app/data_cache
          cp backend/reports/question_effectiveness_*.json backend/app/data_cache/question_effectiveness_latest.json || true
          
      - name: Export accepted patches
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          GITHUB_SHA: ${{ github.sha }}
        run: |
          cd backend
          python scripts/export_patches_for_pr.py
          
      - name: Check for changes
        id: check_changes
        run: |
          cd backend
          if git diff --quiet app/data/*.json; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi
          
      - name: Commit and create PR
        if: steps.check_changes.outputs.has_changes == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config --global user.name "Tuning Bot"
          git config --global user.email "tuning-bot@dotshub.com"
          
          BRANCH_NAME="tuning/auto-$(date +%Y%m%d-%H%M%S)"
          git checkout -b "$BRANCH_NAME"
          
          git add backend/app/data/*.json
          git add backend/app/data_cache/*.json
          git add backend/reports/*.json
          
          git commit -m "ðŸ¤– Auto-tuning: Apply accepted patches

          This PR auto-applies tuning patches from accepted tasks.
          
          Generated by: Tuning Automation workflow
          Deployment bundle: See reports/deploy_bundle_*.json
          "
          
          git push origin "$BRANCH_NAME"
          
          gh pr create \
            --title "ðŸ¤– Auto-tuning: $(date +%Y-%m-%d)" \
            --body "**Auto-generated tuning PR**
            
            This PR applies accepted tuning patches to config files.
            
            **Changes:**
            - Updated config files based on tuning tasks
            - Refreshed question effectiveness data
            
            **Review:**
            - Check deployment bundle in \`reports/\` for rollback info
            - Verify config changes make sense
            - Merge when ready (guardrail will auto-check post-merge)
            " \
            --base main \
            --head "$BRANCH_NAME"
            
      - name: Upload reports as artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: tuning-reports
          path: backend/reports/
          retention-days: 30
